<%- include('partials/header') %>

<div class="container" style="padding: 50px 20px; min-height: 80vh;">
    
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 class="section-title">Mon Espace <span>Voyageur</span></h1>
        <p style="color: #666;">GÃ©rez vos rÃ©servations et profitez de vos avantages exclusifs.</p>
    </div>

    <% if(locals.success_msg && success_msg != '') { %>
        <div class="alert alert-success" style="background: #d4edda; color: #155724; padding: 15px; margin-bottom: 20px; border-radius: 5px;">âœ… <%= success_msg %></div>
    <% } %>
    <% if(locals.error_msg && error_msg != '') { %>
        <div class="alert alert-danger" style="background: #f8d7da; color: #721c24; padding: 15px; margin-bottom: 20px; border-radius: 5px;">âš ï¸ <%= error_msg %></div>
    <% } %>

    <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 50px; border: 2px dashed #95a5a6; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 20px;">
        <div style="max-width: 450px;">
            <h3 style="margin: 0; color: #2c3e50; font-size: 1.1rem;">ğŸ“¥ Importer un ancien sÃ©jour</h3>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #7f8c8d;">Vous avez rÃ©servÃ© par tÃ©lÃ©phone ou sans compte ? RÃ©cupÃ©rez votre dossier pour dÃ©bloquer vos avantages et noter le voyage !</p>
        </div>
        <form action="/mes-demandes/import" method="POST" style="flex: 1; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" name="reservationNumber" placeholder="NÂ° Dossier (ex: TW-2024-XXX)" required style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <input type="email" name="emailVerification" placeholder="Email de rÃ©servation" required style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <button type="submit" class="btn-login" style="background: #2c3e50; color: white; border: none; padding: 0 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Valider</button>
        </form>
    </div>

    <% if (locals.loyalty) { %>
        <div style="background: linear-gradient(135deg, #000000 0%, #434343 100%); color: white; padding: 40px 30px; border-radius: 20px; margin-bottom: 50px; box-shadow: 0 15px 30px rgba(0,0,0,0.3);">
            
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="font-size: 2.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px;">ğŸ‘‘ Wonder Club</h2>
                <div style="margin-top: 5px; font-size: 1.2rem; color: <%= loyalty.color %>; font-weight: bold;">
                    Statut : <%= loyalty.level %>
                </div>

                <div style="max-width: 500px; margin: 25px auto 0 auto;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; color: #ccc;">
                        <span>Progression</span>
                        <% if (loyalty.nextTarget === 100) { %>
                            <span>Niveau Max Atteint !</span>
                        <% } else { %>
                            <span><%= loyalty.count %> / <%= loyalty.nextTarget %> sÃ©jours</span>
                        <% } %>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden;">
                        <div style="width: <%= loyalty.percentage %>%; height: 100%; background: linear-gradient(90deg, #f1c40f, #e67e22); border-radius: 10px; transition: width 0.5s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                
                <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid #cd7f32; position: relative; <%= loyalty.level === 'Wonder 1' ? 'background: rgba(205, 127, 50, 0.15); box-shadow: 0 0 15px rgba(205, 127, 50, 0.3);' : '' %>">
                    <h3 style="color: #cd7f32; margin-top: 0; border-bottom: 1px solid rgba(205, 127, 50, 0.3); padding-bottom: 10px;">ğŸ¥‰ Wonder 1</h3>
                    <p style="font-size: 0.9rem; font-style: italic; opacity: 0.8; margin-bottom: 15px;">2 sÃ©jours requis</p>
                    <ul style="padding-left: 20px; line-height: 1.6; font-size: 0.9rem;">
                        <li>Inscription prioritaire ğŸš€</li>
                        <li>-5% sur le sÃ©jour ğŸ·ï¸</li>
                    </ul>
                    <% if(loyalty.level === 'Wonder 1') { %> <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem;">âœ…</div> <% } %>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid #c0c0c0; position: relative; <%= loyalty.level === 'Wonder 2' ? 'background: rgba(192, 192, 192, 0.15); box-shadow: 0 0 15px rgba(192, 192, 192, 0.3);' : '' %>">
                    <h3 style="color: #c0c0c0; margin-top: 0; border-bottom: 1px solid rgba(192, 192, 192, 0.3); padding-bottom: 10px;">ğŸ¥ˆ Wonder 2</h3>
                    <p style="font-size: 0.9rem; font-style: italic; opacity: 0.8; margin-bottom: 15px;">5 sÃ©jours requis</p>
                    <ul style="padding-left: 20px; line-height: 1.6; font-size: 0.9rem;">
                        <li>Inscription prioritaire ğŸš€</li>
                        <li>-10% sur les sÃ©jours ğŸ·ï¸</li>
                        <li>Petit dÃ©j compris (sur certains sÃ©jours) â˜•</li>
                        <li>Option gratuite (sur certains sÃ©jours) ğŸ</li>
                    </ul>
                    <% if(loyalty.level === 'Wonder 2') { %> <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem;">âœ…</div> <% } %>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid #ffd700; position: relative; <%= loyalty.level === 'Wonder 3' ? 'background: rgba(255, 215, 0, 0.15); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);' : '' %>">
                    <h3 style="color: #ffd700; margin-top: 0; border-bottom: 1px solid rgba(255, 215, 0, 0.3); padding-bottom: 10px;">ğŸ¥‡ Wonder 3</h3>
                    <p style="font-size: 0.9rem; font-style: italic; opacity: 0.8; margin-bottom: 15px;">10 sÃ©jours requis</p>
                    <ul style="padding-left: 20px; line-height: 1.6; font-size: 0.9rem;">
                        <li>Inscription prioritaire ğŸš€</li>
                        <li>-15% sur les sÃ©jours ğŸ’</li>
                        <li>AccÃ¨s aux soirÃ©es Parc privatisÃ© ğŸ°</li>
                        <li>Petit dÃ©j compris (sur certains sÃ©jours) â˜•</li>
                        <li>Surclassement offert (sur certains sÃ©jours) ğŸ›Œ</li>
                        <li>Option gratuite (sur certains sÃ©jours) ğŸ</li>
                    </ul>
                    <% if(loyalty.level === 'Wonder 3') { %> <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem;">âœ…</div> <% } %>
                </div>

            </div>
        </div>
    <% } %>

    <% if (!orders || orders.length === 0) { %>
        <div style="text-align: center; color: #777; margin-top: 50px;">
            <h3>Vous n'avez aucun dossier en cours.</h3>
            <p>Utilisez le formulaire ci-dessus pour importer un ancien sÃ©jour ou rÃ©servez-en un nouveau !</p>
            <div style="margin-top: 20px;">
                <a href="/destinations" class="btn-login">âœˆï¸ Faire un devis</a>
                <a href="/departs-groupes" class="btn-login" style="background: var(--secondary); margin-left: 10px;">ğŸŒ Nos Voyages</a>
            </div>
        </div>
    <% } else { %>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            
            <% orders.forEach(order => { %>
                
                <% 
                    // Gestion Statuts
                    let s = order.status ? order.status.toLowerCase() : '';
                    let statusColor = '#f39c12';
                    let statusIcon = 'â³';
                    
                    if (s.includes('valid') || s.includes('pay')) { statusColor = '#27ae60'; statusIcon = 'âœ…'; }
                    if (s.includes('termin')) { statusColor = '#2c3e50'; statusIcon = 'ğŸ'; }
                    if (s.includes('refus')) { statusColor = '#c0392b'; statusIcon = 'âŒ'; }
                %>

                <div class="card" style="display: flex; flex-direction: column; border-top: 5px solid <%= statusColor %>; height: 100%; border-radius: 15px; overflow: hidden; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    
                    <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fbfbfb;">
                        <span style="font-size: 0.85rem; color: #666; font-weight: bold;">#<%= order.reservationNumber || '...' %></span>
                        <span style="font-size: 0.8rem; background: <%= statusColor %>; color: white; padding: 3px 10px; border-radius: 10px;">
                            <%= order.status %> <%= statusIcon %>
                        </span>
                    </div>

                    <div style="padding: 20px; flex-grow: 1; display: flex; flex-direction: column;">
                        <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1.3rem;"><%= order.tripTitle %></h3>
                        
                        <ul style="color: #555; font-size: 0.9rem; padding-left: 20px; margin-bottom: 20px;">
                            <li>ğŸ‘¤ <strong><%= order.userName %></strong> (<%= order.nbPeople %> pers.)</li>
                            <li>ğŸ’³ Paiement : <%= order.paymentMethod || 'Non dÃ©fini' %></li>
                            <li>ğŸ“… Date : <%= new Date(order.createdAt).toLocaleDateString() %></li>
                        </ul>

                        <div style="margin-top: auto; border-top: 1px solid #eee; padding-top: 15px;">
                            
                            <div style="text-align: right; font-size: 1.4rem; font-weight: bold; color: #333; margin-bottom: 15px;">
                                <%= order.totalPrice ? order.totalPrice + ' â‚¬' : 'Prix Ã  confirmer' %>
                            </div>

                            <% if (s.includes('valid') || s.includes('pay') || s.includes('termin')) { %>
                                <a href="/mes-demandes/facture/<%= order._id %>" class="btn-login" style="display:block; text-align:center; background: #34495e; color: white; text-decoration: none; padding: 10px; border-radius: 5px; font-size: 0.9rem;">
                                    ğŸ“„ TÃ©lÃ©charger Billet PDF
                                </a>
                            <% } %>

                            <% 
                                let alreadyReviewed = false;
                                if (locals.reviewedTripIds && order.tripId) {
                                    alreadyReviewed = reviewedTripIds.includes(order.tripId.toString());
                                }
                                let isPaidOrFinished = s.includes('pay') || s.includes('termin');
                            %>

                            <% if (order.tripId && isPaidOrFinished && !alreadyReviewed) { %>
                                <a href="/mes-demandes/avis/<%= order.tripId %>" class="btn-login" style="display:block; text-align:center; background: #f1c40f; color: #333; text-decoration: none; padding: 10px; border-radius: 5px; margin-top: 10px; font-weight: bold;">
                                    â­ Donner mon avis
                                </a>
                            <% } %>

                            <% if (alreadyReviewed) { %>
                                <div style="text-align: center; margin-top: 10px; color: #f1c40f; font-weight: bold; font-size: 0.9rem;">
                                    âœ… Avis publiÃ©
                                </div>
                            <% } %>

                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } %>
</div>

<%- include('partials/footer') %>
