<%- include('partials/header') %>

<div class="container admin-panel" style="max-width: 1400px;">
    
    <div class="admin-header">
        <h1>üîß Cockpit Administrateur</h1>
        <div style="display: flex; gap: 10px;">
            <a href="/admin/add-trip" class="btn-login" style="background: var(--secondary);">+ Ajouter un S√©jour</a>
            <span class="stats-badge">Total Membres : <%= totalUsers %></span>
        </div>
    </div>

    <% if(success_msg != '') { %><div class="alert alert-success">‚úÖ <%= success_msg %></div><% } %>

    <div class="dashboard-grid" style="margin-bottom: 50px;">
        <div class="dash-card">
            <h3>üìà Clics Totaux</h3>
            <p style="font-size: 2rem; font-weight: bold; color: var(--primary);">
                <% let totalVues = 0; %>
                <% if(locals.tripsStats) { tripsStats.forEach(t => totalVues += t.vues) } %>
                <%= totalVues %>
            </p>
        </div>
        <div class="dash-card">
            <h3>üí∞ Commandes</h3>
            <p style="font-size: 2rem; font-weight: bold; color: #28a745;"><%= orders.length %></p>
        </div>
        <div class="dash-card">
            <h3>‚è≥ Pros en attente</h3>
            <p style="font-size: 2rem; font-weight: bold; color: #ffc107;"><%= pendingPros.length %></p>
        </div>
    </div>

    <div class="admin-section">
        <h2>üí≥ Gestion Financi√®re & R√©servations</h2>
        <div style="overflow-x: auto;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Voyage</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Paiement Actuel</th>
                        <th>Action Paiement</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => { %>
                        <tr>
                            <td>
                                <strong><%= order.userName %></strong><br>
                                <small><%= order.userEmail %></small>
                            </td>
                            <td><%= order.tripTitle %> (<%= order.nbPeople %> pers.)</td>
                            <td style="font-weight: bold;"><%= order.totalPrice %>‚Ç¨</td>
                            <td>
                                <span class="badge" style="background:<%= order.status==='Pay√©e'?'#28a745':'#ffc107' %>; color:white; padding:3px 8px; border-radius:5px;">
                                    <%= order.status %>
                                </span>
                            </td>
                            <td>
                                <%= order.paymentMethod %> <br>
                                <small>(<%= order.paymentStatus %>)</small>
                            </td>
                            <td>
                                <form action="/admin/paiement" method="POST" style="display: flex; gap: 5px; align-items: center;">
                                    <input type="hidden" name="orderId" value="<%= order._id %>">
                                    
                                    <select name="method" style="padding: 5px; border-radius: 5px;">
                                        <option value="CB">CB</option>
                                        <option value="Ch√®que">Ch√®que</option>
                                        <option value="Esp√®ces">Esp√®ces</option>
                                        <option value="Virement">Virement</option>
                                    </select>

                                    <select name="status" style="padding: 5px; border-radius: 5px;">
                                        <option value="Acompte vers√©">Acompte</option>
                                        <option value="Sold√©">Sold√© (Total)</option>
                                    </select>

                                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">OK</button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-section" style="margin-top: 50px;">
        <h2>üìä Popularit√© des S√©jours</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Voyage</th>
                    <th>Vues / Clics</th>
                </tr>
            </thead>
            <tbody>
                <% if(locals.tripsStats) { %>
                    <% tripsStats.forEach(trip => { %>
                        <tr>
                            <td><%= trip.titre %></td>
                            <td>
                                <div style="background: #e9ecef; width: 100%; height: 20px; border-radius: 10px; overflow: hidden; position: relative;">
                                    <div style="background: var(--primary); width: <%= Math.min(trip.vues, 100) %>%; height: 100%;"></div>
                                    <span style="position: absolute; left: 10px; top: 0; font-size: 0.8rem; line-height: 20px; color: black;"><%= trip.vues %> vues</span>
                                </div>
                            </td>
                        </tr>
                    <% }) %>
                <% } %>
            </tbody>
        </table>
    </div>

    <div class="admin-section" style="margin-top: 50px;">
        <h2>üè¢ Pros en attente de validation</h2>
        <% if (pendingPros.length > 0) { %>
            <table class="admin-table">
                <thead><tr><th>Soci√©t√©</th><th>Nom</th><th>Action</th></tr></thead>
                <tbody>
                    <% pendingPros.forEach(user => { %>
                        <tr>
                            <td><%= user.company %> (<%= user.siret %>)</td>
                            <td><%= user.name %></td>
                            <td><a href="/admin/validate/<%= user._id %>" class="btn-action btn-validate">Valider</a></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p>R.A.S</p>
        <% } %>
    </div>

</div>
<%- include('partials/footer') %>